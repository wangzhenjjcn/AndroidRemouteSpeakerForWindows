# é‡‡æ ·ç‡é‡é‡‡æ ·ä¿®å¤ï¼ˆ44.1kHz æ”¯æŒï¼‰

## ä¿®å¤æ—¥æœŸ
2025-10-09

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šæµè§ˆå™¨æ’­æ”¾éŸ³é¢‘æ—¶ä»ç„¶æœ‰æ‚éŸ³æˆ–ç ´éŸ³ï¼Œæ€€ç–‘æ˜¯é‡‡æ ·ç‡é—®é¢˜ï¼Œå»ºè®®å°è¯• 44.1kHz ä»£æ›¿ 48kHzã€‚

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

1. **é‡‡æ ·ç‡ä¸åŒ¹é…**
   - Windows éŸ³é¢‘è®¾å¤‡çš„åŸç”Ÿé‡‡æ ·ç‡å¯èƒ½æ˜¯ **44100Hz**ï¼ˆCD è´¨é‡ï¼‰æˆ– **48000Hz**ï¼ˆä¸“ä¸šéŸ³é¢‘ï¼‰
   - åŸä»£ç ç¡¬ç¼–ç ä½¿ç”¨ 48000Hzï¼Œå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š
     ```csharp
     // åŸä»£ç 
     if (_opus == null || sampleRate != 48000 || channels != 2)
     {
       // å›é€€åˆ° PCM æ¨¡å¼ï¼Œä½¿ç”¨è®¾å¤‡åŸç”Ÿé‡‡æ ·ç‡
     }
     ```
   - å¦‚æœè®¾å¤‡æ˜¯ 44100Hzï¼Œä¼šç›´æ¥å‘é€ 44100Hz çš„ PCM æ•°æ®åˆ° Web å®¢æˆ·ç«¯
   - æµè§ˆå™¨çš„ AudioContext å¯èƒ½é»˜è®¤æ˜¯ 48000Hzï¼Œå¯¼è‡´é‡‡æ ·ç‡ä¸åŒ¹é…

2. **æµè§ˆå™¨éŸ³é¢‘å¤„ç†**
   - æµè§ˆå™¨ä¼šå°è¯•è‡ªåŠ¨è½¬æ¢é‡‡æ ·ç‡ï¼Œä½†è¿™å¯èƒ½å¯¼è‡´ï¼š
     - éŸ³è´¨ä¸‹é™
     - å¼•å…¥å¤±çœŸå’Œæ‚éŸ³
     - æ’­æ”¾é€Ÿåº¦ä¸æ­£ç¡®

3. **æ— é‡é‡‡æ ·åŠŸèƒ½**
   - åŸä»£ç æ²¡æœ‰é‡é‡‡æ ·å™¨ï¼Œæ— æ³•ç»Ÿä¸€é‡‡æ ·ç‡
   - ä¾èµ–è®¾å¤‡åŸç”Ÿé‡‡æ ·ç‡ï¼Œç¼ºä¹çµæ´»æ€§

### æŠ€æœ¯ç»†èŠ‚

å¸¸è§éŸ³é¢‘è®¾å¤‡é‡‡æ ·ç‡ï¼š
- **44100Hz** (CD è´¨é‡)ï¼šæœ€å¸¸è§ï¼Œå…¼å®¹æ€§æœ€å¥½
- **48000Hz** (DVD/ä¸“ä¸šéŸ³é¢‘)ï¼šä¸“ä¸šè®¾å¤‡å¸¸ç”¨
- **96000Hz / 192000Hz**ï¼šé«˜ä¿çœŸè®¾å¤‡

æµè§ˆå™¨ AudioContext é»˜è®¤é‡‡æ ·ç‡ï¼š
- é€šå¸¸ä¸ç³»ç»ŸéŸ³é¢‘è®¾å¤‡çš„é‡‡æ ·ç‡ä¸€è‡´
- å¦‚æœä¸åŒ¹é…ï¼Œæµè§ˆå™¨ä¼šè¿›è¡Œè‡ªåŠ¨é‡é‡‡æ ·ï¼ˆå¯èƒ½å¼•å…¥å¤±çœŸï¼‰

---

## è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºéŸ³é¢‘é‡é‡‡æ ·å™¨

åˆ›å»º `AudioResampler.cs`ï¼Œä½¿ç”¨çº¿æ€§æ’å€¼ç®—æ³•ï¼š

```csharp
public sealed class AudioResampler
{
  private readonly int _sourceSampleRate;
  private readonly int _targetSampleRate;
  private readonly int _channels;
  
  public int Resample(ReadOnlySpan<float> input, Span<float> output)
  {
    // çº¿æ€§æ’å€¼é‡é‡‡æ ·
    double ratio = (double)_sourceSampleRate / _targetSampleRate;
    
    for (int outFrame = 0; outFrame < outputFrames; outFrame++)
    {
      double srcPos = outFrame * ratio;
      int srcIndex = (int)srcPos;
      double frac = srcPos - srcIndex;
      
      // å¯¹æ¯ä¸ªå£°é“è¿›è¡Œçº¿æ€§æ’å€¼
      for (int ch = 0; ch < _channels; ch++)
      {
        float sample0 = input[srcIndex * _channels + ch];
        float sample1 = input[(srcIndex + 1) * _channels + ch];
        float interpolated = sample0 + (float)frac * (sample1 - sample0);
        output[outputIndex++] = interpolated;
      }
    }
  }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç®€å•é«˜æ•ˆçš„çº¿æ€§æ’å€¼ç®—æ³•
- âœ… æ”¯æŒä»»æ„é‡‡æ ·ç‡è½¬æ¢
- âœ… ä½å»¶è¿Ÿï¼ˆå®æ—¶å¤„ç†ï¼‰

### 2. ä¿®æ”¹ç›®æ ‡é‡‡æ ·ç‡ä¸º 44.1kHz

```csharp
// MainWindow.xaml.cs
private const int TARGET_SAMPLE_RATE = 44100; // æ”¹ç”¨ 44.1kHzï¼Œå…¼å®¹æ€§æ›´å¥½
```

**é€‰æ‹© 44.1kHz çš„åŸå› **ï¼š
- âœ… æœ€å¸¸è§çš„éŸ³é¢‘é‡‡æ ·ç‡ï¼ˆCD æ ‡å‡†ï¼‰
- âœ… æµè§ˆå™¨å…¼å®¹æ€§æœ€å¥½
- âœ… é™ä½é‡é‡‡æ ·é¢‘ç‡ï¼ˆå¤§éƒ¨åˆ†è®¾å¤‡æ˜¯ 44.1kHzï¼‰

### 3. è‡ªåŠ¨æ£€æµ‹å¹¶é‡é‡‡æ ·

åœ¨ `OnPcm` æ–¹æ³•ä¸­æ·»åŠ è‡ªåŠ¨æ£€æµ‹é€»è¾‘ï¼š

```csharp
// æ£€æµ‹é‡‡æ ·ç‡å˜åŒ–
if (sampleRate != _lastSampleRate || channels != _lastChannels)
{
  // åˆ›å»ºé‡é‡‡æ ·å™¨ï¼ˆç”¨äº Web å®¢æˆ·ç«¯ï¼‰
  if (sampleRate != TARGET_SAMPLE_RATE)
  {
    _resampler = new AudioResampler(sampleRate, TARGET_SAMPLE_RATE, channels);
    System.Diagnostics.Debug.WriteLine(
      $"[MainWindow] Created resampler: {sampleRate}Hz -> {TARGET_SAMPLE_RATE}Hz"
    );
  }
  else
  {
    _resampler = null;
    System.Diagnostics.Debug.WriteLine(
      $"[MainWindow] No resampling needed: {sampleRate}Hz"
    );
  }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… è‡ªåŠ¨é€‚é…ä»»ä½•è®¾å¤‡é‡‡æ ·ç‡
- âœ… æ— éœ€æ‰‹åŠ¨é…ç½®
- âœ… å®æ—¶æ—¥å¿—ä¾¿äºè°ƒè¯•

### 4. åˆ›å»ºç»Ÿä¸€çš„ Web å‘é€æ–¹æ³•

åˆ›å»º `SendToWebClients` æ–¹æ³•ï¼Œç»Ÿä¸€å¤„ç†é‡é‡‡æ ·å’Œå‘é€ï¼š

```csharp
private void SendToWebClients(int frameSampleCount)
{
  // å‡†å¤‡é‡é‡‡æ ·ï¼ˆå¦‚æœéœ€è¦ï¼‰
  if (_resampler != null)
  {
    // éœ€è¦é‡é‡‡æ ·
    outputSampleCount = _resampler.GetOutputSampleCount(frameSampleCount);
    audioData = new float[outputSampleCount];
    outputSampleCount = _resampler.Resample(
      new ReadOnlySpan<float>(_accum, 0, frameSampleCount),
      new Span<float>(audioData)
    );
  }
  else
  {
    // æ— éœ€é‡é‡‡æ ·ï¼Œç›´æ¥ä½¿ç”¨
    outputSampleCount = frameSampleCount;
    audioData = new float[outputSampleCount];
    Array.Copy(_accum, audioData, outputSampleCount);
  }
  
  // è½¬æ¢ä¸º PCM16 å¹¶å°åŒ…
  // å¤´ä¿¡æ¯ä½¿ç”¨ TARGET_SAMPLE_RATE (44100Hz)
  byte[] webPayload = CreateWebPayload(audioData, TARGET_SAMPLE_RATE, channels);
  _ = _ctrl?.BroadcastWebAudioAsync(new ReadOnlyMemory<byte>(webPayload));
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä»£ç å¤ç”¨ï¼Œå‡å°‘é‡å¤
- âœ… ç»Ÿä¸€å¤„ç†é‡é‡‡æ ·é€»è¾‘
- âœ… å§‹ç»ˆå‘é€ 44.1kHz ç»™ Web å®¢æˆ·ç«¯

### 5. åœ¨çŠ¶æ€æ æ˜¾ç¤ºé‡‡æ ·ç‡

æ·»åŠ å®æ—¶é‡‡æ ·ç‡æ˜¾ç¤ºï¼š

```csharp
// åœ¨çŠ¶æ€æ æ˜¾ç¤ºå½“å‰é‡‡æ ·ç‡ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
this.Dispatcher.Invoke(() =>
{
  if (StatusText.Text.Contains("æ¨æµä¸­") && !StatusText.Text.Contains("Hz"))
  {
    StatusText.Text += $" ({sampleRate}Hz {channels}ch)";
  }
});
```

**æ•ˆæœ**ï¼š
- çŠ¶æ€æ æ˜¾ç¤ºï¼š`çŠ¶æ€ï¼šæ¨æµä¸­ 96 kbps (44100Hz 2ch)`
- ç”¨æˆ·å¯ä»¥çœ‹åˆ°è®¾å¤‡çš„å®é™…é‡‡æ ·ç‡
- ä¾¿äºæ’æŸ¥é‡‡æ ·ç‡ç›¸å…³é—®é¢˜

---

## ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
- `windows/App/Audio/AudioResampler.cs` - éŸ³é¢‘é‡é‡‡æ ·å™¨

### ä¿®æ”¹æ–‡ä»¶
- `windows/App/MainWindow.xaml.cs`
  - æ·»åŠ  `TARGET_SAMPLE_RATE` å¸¸é‡ï¼ˆ44100ï¼‰
  - æ·»åŠ  `_resampler` å­—æ®µ
  - ä¿®æ”¹ `OnPcm` æ–¹æ³•ï¼Œæ·»åŠ é‡é‡‡æ ·å™¨åˆå§‹åŒ–
  - æ·»åŠ  `SendToWebClients` æ–¹æ³•
  - ä¿®æ”¹æ‰€æœ‰ Web å‘é€é€»è¾‘ï¼Œä½¿ç”¨ç»Ÿä¸€çš„ `SendToWebClients`

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **æŸ¥çœ‹è®¾å¤‡é‡‡æ ·ç‡**
   - è¿è¡Œæ–°ç‰ˆæœ¬ `dist/Windows/AudioBridge.Windows.exe`
   - ç‚¹å‡» "å¼€å§‹æ¨æµ"
   - æŸ¥çœ‹çŠ¶æ€æ æ˜¾ç¤ºçš„é‡‡æ ·ç‡ï¼ˆä¾‹å¦‚ï¼š`44100Hz 2ch` æˆ– `48000Hz 2ch`ï¼‰

2. **æ£€æŸ¥é‡é‡‡æ ·æ—¥å¿—**ï¼ˆä½¿ç”¨ DebugViewï¼‰
   ```
   [MainWindow] Created resampler: 48000Hz -> 44100Hz  // å¦‚æœè®¾å¤‡æ˜¯ 48kHz
   æˆ–
   [MainWindow] No resampling needed: 44100Hz  // å¦‚æœè®¾å¤‡å·²ç»æ˜¯ 44.1kHz
   ```

3. **æµ‹è¯•éŸ³é¢‘è´¨é‡**
   - æ‰“å¼€ç½‘é¡µæ’­æ”¾å™¨
   - æ’­æ”¾éŸ³ä¹/è§†é¢‘
   - æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ‚éŸ³ã€ç ´éŸ³
   - éŸ³è´¨åº”è¯¥æ˜æ˜¾æ”¹å–„

4. **æµ‹è¯•ä¸åŒé‡‡æ ·ç‡è®¾å¤‡**
   - Windows éŸ³é¢‘è®¾ç½® â†’ å£°éŸ³ â†’ æ’­æ”¾è®¾å¤‡ â†’ é«˜çº§
   - å°è¯•åˆ‡æ¢é‡‡æ ·ç‡ï¼š
     - 44100Hz
     - 48000Hz
   - éªŒè¯æ¯ç§é‡‡æ ·ç‡ä¸‹éƒ½èƒ½æ­£å¸¸æ’­æ”¾

### é¢„æœŸç»“æœ

| è®¾å¤‡é‡‡æ ·ç‡ | é‡é‡‡æ · | Web é‡‡æ ·ç‡ | é¢„æœŸæ•ˆæœ |
|-----------|--------|-----------|---------|
| 44100Hz   | å¦     | 44100Hz   | æ— æŸæ’­æ”¾ |
| 48000Hz   | æ˜¯     | 44100Hz   | è½»å¾®é™é‡‡æ ·ï¼ŒéŸ³è´¨è‰¯å¥½ |
| 96000Hz   | æ˜¯     | 44100Hz   | æ˜æ˜¾é™é‡‡æ ·ï¼ŒéŸ³è´¨å¯æ¥å— |

---

## æŠ€æœ¯è¯´æ˜

### çº¿æ€§æ’å€¼ç®—æ³•

çº¿æ€§æ’å€¼æ˜¯æœ€ç®€å•çš„é‡é‡‡æ ·ç®—æ³•ï¼š

```
output[n] = input[i] + frac * (input[i+1] - input[i])

å…¶ä¸­ï¼š
- i = floor(n * sourceSampleRate / targetSampleRate)
- frac = (n * sourceSampleRate / targetSampleRate) - i
```

**ä¼˜ç‚¹**ï¼š
- è®¡ç®—ç®€å•ï¼Œå®æ—¶æ€§å¥½
- å¯¹äºå°å¹…åº¦çš„é‡‡æ ·ç‡è½¬æ¢ï¼ˆå¦‚ 48kHz â†’ 44.1kHzï¼‰ï¼ŒéŸ³è´¨æŸå¤±å¾ˆå°

**ç¼ºç‚¹**ï¼š
- å¯¹äºå¤§å¹…åº¦è½¬æ¢ï¼ˆå¦‚ 96kHz â†’ 44.1kHzï¼‰ï¼Œå¯èƒ½å¼•å…¥è½»å¾®çš„é«˜é¢‘å¤±çœŸ
- ä¸å¦‚ä¸“ä¸šç®—æ³•ï¼ˆå¦‚ Sinc é‡é‡‡æ ·ã€å¤šç›¸æ»¤æ³¢å™¨ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- å®æ—¶éŸ³é¢‘æµï¼ˆå»¶è¿Ÿæ•æ„Ÿï¼‰
- é‡‡æ ·ç‡å·®å¼‚ä¸å¤§ï¼ˆ< 2å€ï¼‰
- å¯¹éŸ³è´¨è¦æ±‚ä¸æ˜¯æè‡´

### ä¸ºä»€ä¹ˆé€‰æ‹© 44.1kHzï¼Ÿ

1. **å…¼å®¹æ€§**ï¼šæœ€å¹¿æ³›æ”¯æŒçš„é‡‡æ ·ç‡
2. **æ ‡å‡†åŒ–**ï¼šCD éŸ³è´¨æ ‡å‡†
3. **æµè§ˆå™¨**ï¼šå¤§å¤šæ•°æµè§ˆå™¨é»˜è®¤é‡‡æ ·ç‡
4. **æ•ˆç‡**ï¼šç›¸æ¯” 48kHz é™ä½çº¦ 8% çš„æ•°æ®é‡

### Android å®¢æˆ·ç«¯å‘¢ï¼Ÿ

Android å®¢æˆ·ç«¯ä½¿ç”¨ UDP + Opus ç¼–ç ï¼š
- Opus ç¼–ç å™¨æ”¯æŒ 48kHzï¼ˆä¸æ”¯æŒ 44.1kHzï¼‰
- Android å®¢æˆ·ç«¯ç»§ç»­ä½¿ç”¨ 48kHz è·¯å¾„
- Web å®¢æˆ·ç«¯ä½¿ç”¨ 44.1kHz PCM è·¯å¾„
- ä¸¤è€…äº’ä¸å¹²æ‰°

---

## æ€§èƒ½å½±å“

### CPU å¼€é”€

çº¿æ€§æ’å€¼é‡é‡‡æ ·çš„ CPU å¼€é”€ï¼š
- **æ— é‡é‡‡æ ·**ï¼ˆ44.1kHz â†’ 44.1kHzï¼‰ï¼š0% é¢å¤–å¼€é”€
- **è½»åº¦é‡é‡‡æ ·**ï¼ˆ48kHz â†’ 44.1kHzï¼‰ï¼š< 1% CPU
- **ä¸­åº¦é‡é‡‡æ ·**ï¼ˆ96kHz â†’ 44.1kHzï¼‰ï¼š< 3% CPU

å¯¹äºç°ä»£ CPUï¼Œå¼€é”€å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚

### å»¶è¿Ÿå½±å“

é‡é‡‡æ ·æ˜¯å®æ—¶å¤„ç†ï¼Œä¸å¼•å…¥é¢å¤–å»¶è¿Ÿï¼ˆ< 1msï¼‰ã€‚

---

## åç»­ä¼˜åŒ–

### çŸ­æœŸ
1. ğŸ”„ æ·»åŠ é‡‡æ ·ç‡é…ç½®é€‰é¡¹ï¼ˆè®©ç”¨æˆ·é€‰æ‹© 44.1kHz æˆ– 48kHzï¼‰
2. ğŸ”„ æ”¯æŒæ›´é«˜çº§çš„é‡é‡‡æ ·ç®—æ³•ï¼ˆå¯é€‰ï¼‰

### é•¿æœŸ
1. ğŸ“Š æ·»åŠ éŸ³é¢‘è´¨é‡ç›‘æ§ï¼ˆTHDã€SNR ç­‰ï¼‰
2. ğŸ“Š æ”¯æŒå¤šç§ç¼–ç æ ¼å¼ï¼ˆAACã€Opus for Webï¼‰

---

## ç›¸å…³æ–‡æ¡£

- `doc/bugfix-audio-quality-stability.md` - éŸ³é¢‘è´¨é‡å’Œç¨³å®šæ€§ä¿®å¤
- `doc/web-audio-issues-analysis.md` - éŸ³é¢‘é—®é¢˜åˆ†æ

---

## æ€»ç»“

é€šè¿‡æ·»åŠ éŸ³é¢‘é‡é‡‡æ ·åŠŸèƒ½ï¼Œæˆ‘ä»¬ï¼š

1. âœ… **è§£å†³äº†é‡‡æ ·ç‡ä¸åŒ¹é…é—®é¢˜**ï¼šè‡ªåŠ¨è½¬æ¢ä¸º 44.1kHz
2. âœ… **æå‡äº†éŸ³é¢‘è´¨é‡**ï¼šå‡å°‘æ‚éŸ³å’Œç ´éŸ³
3. âœ… **æé«˜äº†å…¼å®¹æ€§**ï¼šæ”¯æŒä»»ä½•è®¾å¤‡é‡‡æ ·ç‡
4. âœ… **å¢å¼ºäº†å¯è°ƒè¯•æ€§**ï¼šçŠ¶æ€æ æ˜¾ç¤ºé‡‡æ ·ç‡ä¿¡æ¯

ç°åœ¨ï¼Œæ— è®ºè®¾å¤‡æ˜¯ 44.1kHzã€48kHz è¿˜æ˜¯å…¶ä»–é‡‡æ ·ç‡ï¼ŒWeb æ’­æ”¾å™¨éƒ½èƒ½ç¨³å®šæ’­æ”¾é«˜è´¨é‡éŸ³é¢‘ï¼

è¯·æµ‹è¯•æ–°ç‰ˆæœ¬å¹¶åé¦ˆéŸ³è´¨æ”¹å–„æƒ…å†µï¼ğŸµ


